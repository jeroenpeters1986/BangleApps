<html>
<head>
    <link rel="stylesheet" href="../../css/spectre.min.css">
</head>
<body>
    <h3>Bluetooth / BLE</h3>

    <div class="form-group">
        <label class="form-switch" for="ble">
            <input type="checkbox" id="ble" name="ble"/>
            <i class="form-icon"></i> Bluetooth ON
        </label>
    </div>

    <div class="form-group">
        <label class="form-switch" for="blerepl">
            <input type="checkbox" id="blerepl" name="blerepl"/>
            <i class="form-icon"></i> Make programmable
        </label>
    </div>

    <div class="form-group">
        <label class="form-switch" for="log">
            <input type="checkbox" id="log" name="log"/>
            <i class="form-icon"></i> Show debug log
        </label>
    </div>



    <h3>LCD / Screen</h3>

    <div class="form-group">
        <label for="timeout">LCD Timeout
            <br><small>Seconds to keep the backlight on</small>
        </label>
        <select class="form-select" id="timeout">
            <option>5</option>
            <option>10</option>
            <option>15</option>
            <option>20</option>
            <option>25</option>
            <option>30</option>
            <option>45</option>
            <option>60</option>
            <option>120</option>
        </select>
    </div>

    <div class="form-group">
        <label for="brightness">LCD Brightness</label>
        <select class="form-select" id="brightness">
            <option>1</option>
            <option>0.9</option>
            <option>0.8</option>
            <option>0.7</option>
            <option>0.6</option>
            <option>0.5</option>
            <option>0.4</option>
            <option>0.3</option>
            <option>0.3</option>
            <option>0.2</option>
            <option>0.1</option>
            <option>0</option>
        </select>
    </div>

    <div class="form-group">
        <label for="theme">Theme</label>
        <select class="form-select" id="theme">
            <option>Light</option>
            <option>Dark</option>
        </select>
    </div>

    <div class="form-group">
        <label class="form-switch" for="wakebtn1">
            <input type="checkbox" id="wakebtn1" name="wakebtn1"/>
            <i class="form-icon"></i> Wake on BTN1
        </label>
    </div>

    <div class="form-group">
        <label class="form-switch" for="wakefaceup">
            <input type="checkbox" id="wakefaceup" name="wakefaceup"/>
            <i class="form-icon"></i> Wake on Face Up
        </label>
    </div>

    <div class="form-group">
        <label class="form-switch" for="waketouch">
            <input type="checkbox" id="waketouch" name="waketouch"/>
            <i class="form-icon"></i> Wake on Touch
        </label>
    </div>

    <div class="form-group">
        <label class="form-switch" for="waketwist">
            <input type="checkbox" id="waketwist" name="waketwist"/>
            <i class="form-icon"></i> Wake on Twist
        </label>
    </div>



    <h3>Alerts</h3>

    <div class="form-group">
        <label for="quiet">Quiet mode</label>
        <select class="form-select" id="quiet">
            <option value="0">Off</option>
            <option value="1">Priority only</option>
            <option value="2">Total silence</option>
        </select>
    </div>

    <div class="form-group">
        <label class="form-switch" for="vibrate">
            <input type="checkbox" id="vibrate" name="vibrate"/>
            <i class="form-icon"></i> Vibrate
        </label>
    </div>



    <h3>Misc</h3>

    <div class="form-group">
        <label class="form-switch" for="12hour">
            <input type="checkbox" id="12hour" name="12hour"/>
            <i class="form-icon"></i> Use the 12-hour clock (AM/PM)
        </label>
    </div>

    <div class="form-group">
        <label class="form-switch" for="hid">
            <input type="checkbox" id="hid" name="hid"/>
            <i class="form-icon"></i> Act as HID
        </label>
    </div>


    <p><button id="upload" class="btn btn-primary"><i class="icon-upward"></i> Apply settings to Bangle</button></p>


    <script src="https://www.puck-js.com/puck.js"></script>
    <script src="../../loader.js"></script>
    <script src="../../core/js/ui.js"></script>
    <script src="../../core/lib/customize.js"></script>
    <script src="../../core/js/comms.js"></script>

    <script>
    let isB1; // is Bangle.js 1?
    let isB2; // is Bangle.js 2?

    let currentSettings = [];

    // Called when we know what device we're using
    function onInit(device) {
        isB2 = (device && device.id=="BANGLEJS2");
        isB1 = !isB2;
        console.log("Bangle1:", isB1);
        console.log("Bangle2:", isB2);

        let storageFiles;
        console.log("Listing normal files...");
        Comms.reset()
            .then(() => Comms.listFiles({sf:false}))
            .then(f => {
            storageFiles = f;
            let filename = 'setting.json';
            let promise = Promise.resolve();
            promise = promise.then(() => {
                console.log(`Download ${filename}`);
                return Comms.readStorageFile(filename).then(data => { console.log(filename, data) });
            });
            return promise;
        }).then(content => {
            console.log('Backup complete!');
        }).catch(err => {
            console.log('Backup failed: ' + err);
        });
    }

    function generateSettings() {

        let setting_ble = document.getElementById("ble").checked;
        let setting_blerepl = document.getElementById("blerepl").checked;
        let setting_log = document.getElementById("log").checked;
        let setting_hid = document.getElementById("hid").checked;
        let setting_quiet = parseInt(document.getElementById("quiet").value);
        let setting_timeout = parseInt(document.getElementById("timeout").value);
        let setting_12hour = document.getElementById("12hour").checked;
        let setting_vibrate = document.getElementById("vibrate").checked;
        let setting_wakebtn1 = document.getElementById("wakebtn1").checked;
        let setting_wakefaceup = document.getElementById("wakefaceup").checked;
        let setting_waketouch = document.getElementById("waketouch").checked;
        let setting_waketwist = document.getElementById("waketwist").checked;
        let setting_theme = document.getElementById("theme").value;

        let setting_brightness = document.getElementById("brightness").value;
        if(setting_brightness === "1" || setting_brightness === 0)
        {
            setting_brightness = parseInt(setting_brightness);
        } else {
            setting_brightness = parseFloat(setting_brightness).toFixed(1)
        }

        let settings = {
            ble: setting_ble,                               // Bluetooth enabled by default
            blerepl: setting_blerepl,                       // Is REPL on Bluetooth - can Espruino IDE be used?
            log: setting_log,                               // Do log messages appear on screen?
            quiet: setting_quiet,                           // quiet mode:  0: off, 1: priority only, 2: total silence
            timeout: setting_timeout,                       // Default LCD timeout in seconds
            vibrate: setting_vibrate,                       // Vibration enabled by default. App must support
            // TODO: beep: BANGLEJS2?true:"vib",            // Beep enabled by default. App must support
            timezone: (new Date()).getTimezoneOffset()/-60, // Set the timezone for the device
            HID: setting_hid,                               // BLE HID mode, off by default
            // TODO: clock: null,                              // a string for the default clock's name
            "12hour" : setting_12hour,                      // 12 or 24 hour clock?
            brightness: setting_brightness,                 // LCD brightness from 0 to 1
            welcomed : false,                               // Show the welcome app
            options: {
                wakeOnBTN1: setting_wakebtn1,
                wakeOnBTN2: true,
                wakeOnBTN3: true,
                wakeOnFaceUp: setting_wakefaceup,
                wakeOnTouch: setting_waketouch,
                wakeOnTwist: setting_waketwist,
                twistThreshold: 1638.4,
                twistMaxY: -800,
                twistTimeout: 1000
            },
        };

        if(setting_theme === "Dark") {
            settings.theme = {
                "fg": 65535,
                "bg": 0,
                "fg2": 65535,
                "bg2": 8,
                "fgH": 65535,
                "bgH": 31,
                "dark": true
            }
        }

        return settings;
    }

    // When the 'upload' button is clicked...
    document.getElementById("upload").addEventListener("click", function() {

        console.log(generateSettings());

        // send finished app (in addition to contents of app.json)
        sendCustomizedApp({storage:[
            {name:"setting.json", url:"setting.json", content:JSON.stringify(generateSettings())}
        ]});
    });

    </script>
</body>
</html>
